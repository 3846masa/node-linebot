<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">es2015/LineBot/index.js | @3846masa/linebot | ESDoc API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
<link data-ice="userStyle" rel="stylesheet" href="user/css/0-styles.css">
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  <a href="./manual/index.html" data-ice="manualHeaderLink">Manual</a>
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/3846masa/node-linebot" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-LineBotConfig">LineBotConfig</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-LineProfile">LineProfile</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Rectangle">Rectangle</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-Size">Size</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://github.com/asyncly/EventEmitter2#api">EventEmitter2</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="http://expressjs.com/en/4x/api.html">Express.Application</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/http.html#http_class_http_server">http.Server</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/stream.html#stream_class_stream_readable">stream.Readable</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">LineActions</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineActions/index.js~ImagemapAction.html">ImagemapAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineActions/index.js~ImagemapMessageAction.html">ImagemapMessageAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineActions/index.js~ImagemapURIAction.html">ImagemapURIAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineActions/index.js~TemplateAction.html">TemplateAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineActions/index.js~TemplateMessageAction.html">TemplateMessageAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineActions/index.js~TemplatePostbackAction.html">TemplatePostbackAction</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineActions/index.js~TemplateURIAction.html">TemplateURIAction</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">LineBot</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineBot/index.js~LineBot.html">LineBot</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">LineEvents</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~BeaconEvent.html">BeaconEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~FollowEvent.html">FollowEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~JoinEvent.html">JoinEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~LeaveEvent.html">LeaveEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~LineEvent.html">LineEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~MessageEvent.html">MessageEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~PostbackEvent.html">PostbackEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~ReplyableEvent.html">ReplyableEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineEvents/index.js~UnfollowEvent.html">UnfollowEvent</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">LineMessages</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~AudioMessage.html">AudioMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~ImageMessage.html">ImageMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~ImagemapMessage.html">ImagemapMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~LineMessage.html">LineMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~LocationMessage.html">LocationMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~StickerMessage.html">StickerMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~TemplateMessage.html">TemplateMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~TextMessage.html">TextMessage</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineMessages/index.js~VideoMessage.html">VideoMessage</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">LineSources</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineSources/index.js~GroupSource.html">GroupSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineSources/index.js~LineSource.html">LineSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineSources/index.js~RoomSource.html">RoomSource</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineSources/index.js~UserSource.html">UserSource</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">LineTemplates</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineTemplates/index.js~TemplateButtons.html">TemplateButtons</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineTemplates/index.js~TemplateCarousel.html">TemplateCarousel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineTemplates/index.js~TemplateColumn.html">TemplateColumn</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineTemplates/index.js~TemplateComponent.html">TemplateComponent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/es2015/LineTemplates/index.js~TemplateConfirm.html">TemplateConfirm</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">es2015/LineBot/index.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">import { createHmac, createHash } from &apos;crypto&apos;;
import { EventEmitter2 } from &apos;eventemitter2&apos;;
import axios from &apos;axios&apos;;
import express from &apos;express&apos;;
import bodyParser from &apos;body-parser&apos;;
import { LineEvent } from &apos;../LineEvents&apos;;
import { GroupSource, RoomSource } from &apos;../LineSources&apos;;
/* eslint-enable no-unused-vars */
/**
 * LINE Bot API wrapper.
 *
 * @example &lt;caption&gt;EventEmitter&lt;/caption&gt;
 * import { LineBot } from &apos;@3846masa/linebot&apos;;
 * const bot = new LineBot(configs);
 *
 * bot.on(&apos;message&apos;, (result) =&gt; {
 *   console.log(&apos;You got a message!&apos;, result);
 * });
 *
 * bot.listen(3000);
 *
 * @extends {EventEmitter2}
 * @see https://devdocs.line.me/ja/
 */
export class LineBot extends EventEmitter2 {
    /* eslint-enable no-undef */
    /**
     * Constructor
     * @param  {LineBotConfig} config
     */
    constructor({ channelSecret, channelToken }) {
        super({
            wildcard: true,
            delimiter: &apos;:&apos;,
            maxListeners: 20,
        });
        /**
         * Configuration.
         * @type {LineBotConfig}
         */
        this.config = {
            channelSecret,
            channelToken,
        };
        Object.freeze(this.config);
        this._initAxios();
        this._initExpress();
    }
    /** @private */
    _initAxios() {
        /** @private */
        this._axios = axios.create({
            baseURL: &apos;https://api.line.me/v2/bot&apos;,
            headers: {
                Authorization: `Bearer ${this.config.channelToken}`,
            },
            validateStatus: () =&gt; true,
        });
    }
    /** @private */
    _initExpress() {
        /**
         * Configuration.
         * @type {Express.Application}
         */
        this.express = express();
        this.express.use(bodyParser.raw({ type: () =&gt; true }));
        this.express.use((req, res, next) =&gt; {
            const isValid = this._checkSignature({
                signature: req.header(&apos;X-Line-Signature&apos;),
                body: req.body,
            });
            if (!isValid) {
                return next(new Error(&apos;Invalid request.&apos;));
            }
            return next();
        });
        this.express.use((req, res, next) =&gt; {
            Promise.resolve(req.body.toString(&apos;utf8&apos;))
                .then(JSON.parse)
                .then(json =&gt; Object.assign(req, { body: json }))
                .then(() =&gt; next())
                .catch(next);
        });
        this.express.all(&apos;*&apos;, (req, res, next) =&gt; {
            if (!req.body || !req.body.events) {
                return next(new Error(&apos;Invalid JSON.&apos;));
            }
            for (const event of req.body.events) {
                const eventObj = LineEvent.createFromObject(event, this);
                this.emit(`webhook:${event.type}`, eventObj);
            }
            res.status(200).send();
            return next();
        });
        this.express.use((err, req, res, next) =&gt; {
            console.error(err);
            res.status(400).send({ error: err.message });
            next();
        });
    }
    /** @private */
    _checkSignature({ signature, body }) {
        const hmac = createHmac(&apos;sha256&apos;, this.config.channelSecret)
            .update(body).digest(&apos;base64&apos;);
        const hmacHashed = createHash(&apos;sha1&apos;)
            .update(hmac).digest();
        const signatureHashed = createHash(&apos;sha1&apos;)
            .update(signature).digest();
        return hmacHashed.equals(signatureHashed);
    }
    /**
     * Send messages to users, groups, and rooms at any time.
     * @see https://devdocs.line.me/en/#push-message
     * @param  {string}                            to   ID of the receiver
     * @param  {LineMessage[] | LineMessage | any} msg  Messages (Max: 5)
     * @return {Promise&lt;void,Error&gt;}
     */
    push(to, msg) {
        let messages;
        if (!Array.isArray(msg)) {
            messages = [msg];
        }
        else {
            messages = msg;
        }
        const promise = this._post(&apos;/message/push&apos;, { to, messages });
        return promise.then(({ status, data }) =&gt; {
            if (status !== 200) {
                return Promise.reject(new Error(`${status}: ${data.message}`));
            }
            return Promise.resolve();
        });
    }
    /**
     * Retrieve image, video, and audio data sent by users.
     * @see https://devdocs.line.me/en/#get-content
     * @param  {LineMessage} message Message
     * @return {Promise&lt;stream.Readable,Error&gt;}
     */
    getContentFromMessage(message) {
        return this.getContent(message.id);
    }
    /**
     * Retrieve image, video, and audio data sent by users.
     * @see https://devdocs.line.me/en/#get-content
     * @param  {string} messageId Message ID.
     * @return {Promise&lt;stream.Readable,Error&gt;}
     */
    getContent(messageId) {
        const promise = this._get(`/message/${messageId}/content`, {
            responseType: &apos;stream&apos;,
        });
        return promise.then(({ status, statusText, data }) =&gt; {
            if (status !== 200) {
                throw new Error(`${status}: ${statusText}`);
            }
            return Promise.resolve(data);
        });
    }
    /**
     * Send messages to users, groups, and rooms at any time.
     * @see https://devdocs.line.me/en/#bot-api-get-profile
     * @param  {UserSource} user  User source
     * @return {Promise&lt;LineProfile,Error&gt;}
     */
    getProfileFromUserSource(user) {
        return this.getProfile(user.userId);
    }
    /**
     * Send messages to users, groups, and rooms at any time.
     * @see https://devdocs.line.me/en/#bot-api-get-profile
     * @param  {string} userId  User ID
     * @return {Promise&lt;LineProfile,Error&gt;}
     */
    getProfile(userId) {
        const promise = this._get(`/profile/${userId}`);
        return promise.then(({ status, data }) =&gt; {
            if (status !== 200) {
                throw new Error(`${status}: ${data.message}`);
            }
            return Promise.resolve(data);
        });
    }
    /**
     * Leave a group or room.
     * @see https://devdocs.line.me/en/#leave
     * @param  {GroupSource | RoomSource}  source
     * @return {Promise&lt;void,Error&gt;}
     */
    leaveFromSource(source) {
        if (source instanceof GroupSource) {
            return this.leave(&apos;group&apos;, source.groupId);
        }
        else if (source instanceof RoomSource) {
            return this.leave(&apos;room&apos;, source.roomId);
        }
        return Promise.resolve();
    }
    /**
     * Leave a group or room.
     * @see https://devdocs.line.me/en/#leave
     * @param  {string} type
     * @param  {string} id
     * @return {Promise&lt;void,Error&gt;}
     */
    leave(type, id) {
        const promise = this._post(`/${type}/${id}/leave`);
        return promise.then(({ status, data }) =&gt; {
            if (status !== 200) {
                return Promise.reject(new Error(`${status}: ${data.message}`));
            }
            return Promise.resolve();
        });
    }
    /** @private */
    _get(endpoint, options) {
        return this._axios.get(endpoint, options || {});
    }
    /** @private */
    _post(endpoint, data, options) {
        return this._axios.post(endpoint, data, options || {});
    }
    /**
     * Binds and listens for connections on the specified host and port.
     * @see http://expressjs.com/en/4x/api.html#app.listen
     * @param  { ...any }    args http://expressjs.com/en/4x/api.html#app.listen
     * @return {http.Server}
     */
    listen(...args) {
        return this.express.listen.call(this.express, ...args);
    }
    /**
     * Adds a listener to the end of the listeners array for the specified event.
     * @see https://github.com/asyncly/EventEmitter2#emitteronevent-listener
     * @param   {string | string[]} event    Event name
     * @param   {Function}          listener Listener function
     * @return  {LineBot}
     * @listens {webhook:{eventType}}  Listen message event. https://developers.line.me/bot-api/api-reference#sending_message
     */
    on(event, listener) {
        super.on(event, listener);
        return this;
    }
}
export default LineBot;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.8)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
